<!DOCTYPE html>
<html>
    <head>
        <title>Title</title>
    </head>
    <body>
        <script>
            // Set root URLs
            var rootURL = "https://diggsml.org/schemas/";

            // Set schema version to query
            var version = 2.6;
             //In the future, add dropdown to select version

             // Declare array to hold procedure name, substitution group, and documentation
            var list = new Array();

            //Construct api URL for schema repository
            var api =  "https://api.github.com/repos/diggsml/schemas/contents/"+ version;

            //Start main function
            main(api);
                    




            async function main(api) {
                let repoObject = await fetch(api);
                let repoJson = await repoObject.json();

                //Set array counter
                var listcnt = 0;

                // Now loop through the xsd files to build the list arrays
                for (let rec of repoJson) {

                    //Set string pointers to extract  sufffix of the repository item
                    var len = rec.name.length;
                    var start = len - 3;

                    //Check that item is a file and that it has xsd as a suffix
                    if (rec.type === "file" && rec.name.substring(start, len) == "xsd") {  //If true we've found an xsd file, so let's examine it

                        //Set URL of the file to fetch
                        var url = rootURL + version + '/' + rec.name;


                        //Fetch the file
                        let schObject = await fetch(url);
                        let schText = await schObject.text();

                        //Parse schText into XML DOM object
                        const xmlObj = new window.DOMParser().parseFromString(schText, "text/xml");

                        //Call function to return the namespace of the xsd file
                        var nameSpace = xmlObj.documentElement.attributes.getNamedItem("targetNamespace").nodeValue;

                        //Check to see if this is a DIGGS namespace
                        if (nameSpace === "http://diggsml.org/schemas/2.6/geotechnical" || nameSpace === "http://diggsml.org/schemas/2.6"){

                            //Yes, this is a DIGGS namespace schema file, so let's record shortened nameSpace
                            if (nameSpace === "http://diggsml.org/schemas/2.6/geotechnical") nameSpace = "diggs_geo";
                            if (nameSpace === "http://diggsml.org/schemas/2.6/geotechnical") nameSpace = "diggs";

                            console.log(" ");
                            console.log(rec.name +"---"+ nameSpace);
                            console.log("---------------------------------------------------");

                            //Now, let's look at the elements in the file 
                            var elements=xmlObj.getElementsByTagName("element");
                            for (var j = 0; j < elements.length; j++) {

                                //See if there is a substttutionGroup attribute, if not go to next element
                                var subgroup = "";
                                try {
                                    subgroup = elements[j].attributes.getNamedItem("substitutionGroup").nodeValue;
                                } catch (error) {
                                    continue;
                                }

                                //Parse subgroup to see if it is a procedure
                                var start = subgroup.length - 9;
                                if(subgroup.substring(start,subgroup.length) == "Procedure") { //Yes, we have a Procedure element, now populate the list array
                                    var elName = elements[j].attributes.getNamedItem("name").nodeValue;

                                    //Check to see if there's an annotation element
                                    var eldoc = "";
                                    try {
                                        if(elements[j].firstChild.nextSibling.nodeName == "annotation"){
                                            try {
                                            elDoc = elements[j].firstChild.nextSibling.firstChild.nextSibling.childNodes[0].nodeValue;                                           
                                            } catch (error) {
                                                elDoc = "";
                                            }
                                        } 
                                    } catch (error) {
                                        elDoc="";
                                    }
                                    var elLink = "https://diggsml.org/docs/"+version+"/"+rec.name.substring(0,rec.name.length-4)+"_xsd_Element_"+nameSpace+"_"+elName+".html#"+elName;
                                    //console.log(elName + " | " + subgroup  + " | " + elDoc + " | " + elLink);
                                    console.log(elName + " | " + subgroup);
                                }
                            }
                        }


                    };
                };
            };

            function write(){
                //write out results
                for (i = 0; i < xsdList.length; i ++) {
                        console.log(xsdList[i]);
                }
            }


            async function schemaText(url) {

  
            };

 
/*
            function loadXml(xmlFile){

                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                       var xmlObj = this.responseXML;
                       
                    }
                };
                xhttp.open("GET", xmlFile, true);
                xhttp.send();
            };
*/
            /*
            window.onload = start;
            function start() {
                var file1 = "https://diggsml.org/schemas/2.6/Geotechnical.xsd";
                var file2 = "https://diggsml.org/schemas/2.6/BetaProcedures.xsd"

                loadXml(file1);
                loadXml(file2);
*/

         </script>
         <h2>Loading...</h2>
     </body>
 </html>
